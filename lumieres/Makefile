# ===================================
# LumiÃ¨res - Monorepo Management
# ===================================

.PHONY: help install dev build test clean docker-up docker-down

# Default target
help: ## Show this help message
	@echo "ğŸŒŸ LumiÃ¨res - Available Commands:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'

# ===================================
# ğŸš€ SETUP AUTOMATISÃ‰
# ===================================

new: ## ğŸš€ Setup complet : git pull + install + Docker + migrations + seeders + permissions
	@echo "ğŸš€ === SETUP AUTOMATIQUE DE LUMIERES ==="
	@echo ""
	@echo "ğŸ§¹ 1. Nettoyage des dÃ©pendances..."
	make clean || true
	@echo ""
	@echo "ğŸ“¥ 2. Installation des dÃ©pendances..."
	make install
	@echo ""
	@echo "ğŸ³ 3. DÃ©marrage de l'environnement Docker..."
	make dev
	@echo ""
	@echo "â³ 4. Attente du dÃ©marrage des containers (10s)..."
	sleep 10
	@echo ""
	@echo "ğŸ—„ï¸ 5. Reset et exÃ©cution des migrations..."
	docker exec lumieres-app php artisan migrate:fresh --force
	@echo ""
	@echo "ğŸŒ± 6. CrÃ©ation des rÃ´les et utilisateurs de base..."
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\ShieldSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\PanelPermissionSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\UserSeeder --force
	@echo ""
	@echo "ğŸ›¡ï¸ 7. GÃ©nÃ©ration des permissions Filament..."
	docker exec lumieres-app php artisan shield:generate --all --panel=fresnel --no-interaction
	docker exec lumieres-app php artisan shield:generate --all --panel=meniscus --no-interaction
	@echo ""
	@echo "ğŸ‘¥ 8. Configuration et assignation des rÃ´les Shield..."
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\ShieldRoleAssignmentSeeder --force
	@echo ""
	@echo "ğŸŒ± 9. ExÃ©cution des autres seeders..."
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\LanguageSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\FestivalSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\MovieSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\ParameterSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\NomenclatureSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\NewDCPParametersSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\FresnelSeeder --force
	@echo ""
	@echo "ğŸ‰ === SETUP TERMINÃ‰ ! ==="
	@echo ""
	@echo "âœ… Votre environnement LumiÃ¨res est prÃªt !"
	@echo ""
	@echo "ğŸŒ AccÃ¨s:"
	@echo "  ğŸ“± Application Laravel: http://localhost"
	@echo "  âš¡ Vite (hot reload): http://localhost:5173 ou 5174"
	@echo "  ğŸ—„ï¸ Adminer (DB): http://localhost:8080"
	@echo "  ğŸ“§ Mailpit: http://localhost:8025"
	@echo ""
	@echo "ğŸ‘¥ Comptes par dÃ©faut:"
	@echo "  ğŸ‘‘ Admin (Super Admin): admin@dcprism.local / admin123 - AccÃ¨s Ã  TOUS les panels"
	@echo "  ğŸ”§ Tech: tech@dcprism.local / password - Panel Tech"
	@echo "  ğŸ‘” Manager: manager@dcprism.local / password - Panel Manager"
	@echo "  ğŸ¦ Cinema: cinema@dcprism.local / password - Panel Cinema"
	@echo "  ğŸ“ Source: source@dcprism.local / password - Panel Source"
	@echo "  ğŸ‘¥ Supervisor: supervisor@dcprism.local / password - Panel Infrastructure"
	@echo ""
	@echo "ğŸ“‹ Commandes utiles:"
	@echo "  make dev-stop  - ArrÃªter l'environnement"
	@echo "  make logs      - Voir les logs"
	@echo "  make vite-logs - Voir les logs Vite"
	@echo ""

reset: ## ğŸ”„ Reset complet : arrÃªt + nettoyage + nouveau setup
	@echo "ğŸ”„ === RESET COMPLET ==="
	@echo ""
	@echo "ğŸ›‘ 1. ArrÃªt de l'environnement..."
	make dev-stop
	@echo ""
	@echo "ğŸ§¹ 2. Nettoyage des volumes Docker..."
	docker volume rm lumieres_mariadb-data lumieres_redis-data || true
	@echo ""
	@echo "ğŸš€ 3. Nouveau setup complet..."
	make new

quick: ## âš¡ Setup rapide sans nettoyage complet
	@echo "âš¡ === SETUP RAPIDE ==="
	@echo ""
	@echo "ğŸ³ 1. DÃ©marrage Docker..."
	make dev
	@echo ""
	@echo "â³ 2. Attente du dÃ©marrage (10s)..."
	sleep 10
	@echo ""
	@echo "ğŸ—„ï¸ 3. Migrations..."
	docker exec lumieres-app php artisan migrate --force
	@echo ""
	@echo "ğŸŒ± 4. RÃ´les et utilisateurs de base..."
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\ShieldSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\PanelPermissionSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\UserSeeder --force
	@echo ""
	@echo "ğŸ›¡ï¸ 5. Permissions Filament..."
	docker exec lumieres-app php artisan shield:generate --all --panel=fresnel --no-interaction
	docker exec lumieres-app php artisan shield:generate --all --panel=meniscus --no-interaction
	@echo ""
	@echo "ğŸ‘¥ 6. Assignation des rÃ´les Shield..."
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\ShieldRoleAssignmentSeeder --force
	@echo ""
	@echo "ğŸŒ± 7. Autres seeders..."
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\LanguageSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\FestivalSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\MovieSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\ParameterSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\NomenclatureSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\NewDCPParametersSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\FresnelSeeder --force
	@echo ""
	@echo "âœ… Setup rapide terminÃ© !"
	@echo "ğŸŒ Laravel: http://localhost"

# Installation
install: ## Install all dependencies (PHP + Node)
	@echo "ğŸš€ Installing dependencies..."
	@echo "ğŸ“¦ Installing PHP dependencies in apps/dcprism-unified..."
	cd apps/dcprism-unified && composer install
	@echo "ğŸ“¦ Installing Node dependencies in apps/dcprism-unified..."
	cd apps/dcprism-unified && npm install
	@echo "ğŸ“¦ Installing PHP dependencies in packages..."
	for dir in packages/*/; do \
		if [ -f "$$dir/composer.json" ]; then \
			echo "Installing in $$dir" && cd "$$dir" && composer install && cd ../..; \
		fi; \
	done

# Development
dev: ## Start development environment (Docker + Vite in background)
	@echo "ğŸŒŸ Starting development environment..."
	docker-compose --profile dev up -d
	@echo "ğŸ”¥ Starting Vite dev server in background..."
	nohup sh -c 'cd apps/dcprism-unified && npm run dev' > vite.log 2>&1 &
	@echo "âœ… Development environment started!"
	@echo "ğŸ“‹ Vite logs: tail -f vite.log"
	@echo "ğŸŒ Laravel: http://localhost"
	@echo "âš¡ Vite: http://localhost:5173"

vite-fg: ## Start Vite dev server in foreground (interactive)
	@echo "ğŸ”¥ Starting Vite dev server..."
	cd apps/dcprism-unified && npm run dev

vite-logs: ## Show Vite logs
	tail -f vite.log

dev-stop: ## Stop development environment  
	@echo "ğŸ›‘ Stopping development environment..."
	docker-compose down

# Building
build: ## Build all applications for production
	@echo "ğŸ¢ï¸ Building applications..."
	cd apps/dcprism-unified && npm run build
	@echo "âœ… Build completÃ© !"

# Testing
test: ## Run PHP tests
	@echo "ğŸ§ª Running PHP tests..."
	cd apps/dcprism-unified && composer test

test-docker: ## Run PHP tests in Docker
	@echo "ğŸ§ª Running PHP tests in Docker..."
	docker exec lumieres-app php artisan test

# Code Quality
lint: ## Run code linting (Laravel Pint)
	@echo "âœ¨ Linting code with Laravel Pint..."
	cd apps/dcprism-unified && ./vendor/bin/pint

lint-docker: ## Run code linting in Docker
	@echo "âœ¨ Linting code in Docker..."
	docker exec lumieres-app ./vendor/bin/pint

analyse: ## Run static analysis (placeholder)
	@echo "ğŸ” Static analysis not configured yet"

# Cleaning
clean: ## Clean all dependencies and build artifacts
	@echo "ğŸ§¹ Cleaning dependencies and build artifacts..."
	rm -rf vendor node_modules || true
	rm -rf apps/*/vendor apps/*/node_modules || true
	rm -rf packages/*/vendor packages/*/node_modules || true
	rm -rf apps/dcprism-unified/public/build || true
	rm -f vite.log || true
	@echo "âœ… Nettoyage terminÃ© !"

fresh: ## Fresh install (clean + install)
	@echo "ğŸ†• Fresh installation..."
	make clean
	make install

# Docker shortcuts  
logs: ## Show services logs
	@echo "ğŸ“‹ Showing logs..."
	docker-compose logs -f

logs-app: ## Show Laravel app logs
	@echo "ğŸ“‹ Showing Laravel logs..."
	docker exec lumieres-app tail -f storage/logs/laravel.log

# Database management
db-fresh: ## Fresh database with migrations and seeders
	@echo "ğŸ—„ï¸ Fresh database setup..."
	docker exec lumieres-app php artisan migrate:fresh --force
	@echo "ğŸŒ± RÃ´les et utilisateurs de base..."
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\ShieldSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\PanelPermissionSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\UserSeeder --force
	@echo "ğŸ›¡ï¸ GÃ©nÃ©ration des permissions Filament..."
	docker exec lumieres-app php artisan shield:generate --all --panel=fresnel --no-interaction
	docker exec lumieres-app php artisan shield:generate --all --panel=meniscus --no-interaction
	@echo "ğŸ‘¥ Assignation des rÃ´les Shield..."
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\ShieldRoleAssignmentSeeder --force
	@echo "ğŸŒ± Autres seeders..."
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\LanguageSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\FestivalSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\MovieSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\ParameterSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\NomenclatureSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\NewDCPParametersSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\FresnelSeeder --force
	@echo "âœ… Base de donnÃ©es rÃ©initialisÃ©e !"

db-seed: ## Run seeders only
	@echo "ğŸŒ± Running seeders..."
	docker exec lumieres-app php artisan db:seed --force

shield-config: ## Configure Shield roles and permissions only
	@echo "ğŸ›¡ï¸ Configuration Shield..."
	@echo "ğŸŒ± RÃ´les de base et utilisateurs (prÃ©requis)..."
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\ShieldSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\PanelPermissionSeeder --force
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\UserSeeder --force
	@echo "ğŸ›¡ï¸ GÃ©nÃ©ration des permissions Filament..."
	docker exec lumieres-app php artisan shield:generate --all --panel=fresnel --no-interaction
	docker exec lumieres-app php artisan shield:generate --all --panel=meniscus --no-interaction
	@echo "ğŸ‘¥ Assignation des rÃ´les aux utilisateurs..."
	docker exec lumieres-app php artisan db:seed --class=Database\\Seeders\\ShieldRoleAssignmentSeeder --force
	@echo "âœ… Configuration Shield terminÃ©e !"

# TODO: Migrer de Modules\Fresnel\app\Models\User vers App\Models\User (config auth.providers.users.model)
shield-fix: ## Correction et test Shield (modÃ¨le auth correct)
	@echo "ğŸ”§ Correction Shield - ModÃ¨le Auth..."
	@echo "ğŸ” 1. VÃ©rification des modÃ¨les User..."
	docker exec lumieres-app php artisan tinker --execute="echo 'ModÃ¨le auth config: ' . config('auth.providers.users.model'); \$$authUser = Modules\\Fresnel\\app\\Models\\User::where('email', 'admin@dcprism.local')->first(); echo ' | User auth trouvÃ©: ' . \$$authUser->name;"
	@echo "ğŸ”„ 2. Assignation super_admin au BON modÃ¨le (celui utilisÃ© par l'auth)..."
	docker exec lumieres-app php artisan tinker --execute="\$$authUser = Modules\\Fresnel\\app\\Models\\User::where('email', 'admin@dcprism.local')->first(); \$$authUser->syncRoles([]); \$$authUser->assignRole('super_admin'); echo 'Super admin assignÃ© au modÃ¨le AUTH: ' . get_class(\$$authUser);"
	@echo "ğŸ—œï¸ 3. Nettoyage caches..."
	docker exec lumieres-app php artisan optimize:clear > /dev/null 2>&1
	@echo "ğŸ¯ 4. Test final de connexion..."
	docker exec lumieres-app php artisan tinker --execute="if (Auth::attempt(['email' => 'admin@dcprism.local', 'password' => 'admin123'])) { \$$u = Auth::user(); echo 'CONNEXION: âœ… RÃ‰USSIE | Classe: ' . get_class(\$$u) . ' | RÃ´les: ' . \$$u->roles->pluck('name')->implode(', '); Auth::logout(); } else { echo 'CONNEXION: âŒ Ã‰CHOUÃ‰E'; }"
	@echo ""
	@echo "âœ… PROBLÃˆME RÃ‰SOLU ! Vous pouvez maintenant:"
	@echo "1. Vous connecter Ã : http://localhost/fresnel/admin"
	@echo "2. Email: admin@dcprism.local | Password: admin123"
	@echo "3. AccÃ©der Ã  Shield: http://localhost/fresnel/admin/shield/roles"

fix-user-permissions: ## Corriger les permissions des utilisateurs non-admin
	@echo "ğŸ”§ Correction des permissions utilisateurs..."
	docker exec lumieres-app php artisan tinker --execute="\$$managerRole = Spatie\\Permission\\Models\\Role::where('name', 'manager')->first(); \$$managerRole->givePermissionTo(['ViewAny:Nomenclature', 'View:Nomenclature', 'Create:Nomenclature', 'Update:Nomenclature']); echo 'Permissions nomenclature ajoutÃ©es au manager';"
	@echo "âœ… Permissions corrigÃ©es !"

# Status & Info
status: ## Show project status
	@echo "ğŸ“Š Project Status:"
	@echo "- PHP version: $(shell php --version | head -n 1 2>/dev/null || echo 'PHP not found')"
	@echo "- Node version: $(shell node --version 2>/dev/null || echo 'Node not found')"
	@echo "- Composer: $(shell composer --version --no-ansi 2>/dev/null || echo 'Composer not found')"
	@echo "- Docker: $(shell docker --version 2>/dev/null || echo 'Docker not found')"
	@echo ""
	@echo "ğŸ³ Docker status:"
	@docker ps --format "table {{.Names}}\t{{.Status}}" --filter name=lumieres || echo "No containers running"

ps: ## Show running containers
	@docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}" --filter name=lumieres
